(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();function I(t){let e=new ArrayBuffer(t);return new Uint8Array(e)}const j="/phasetida-node-demo/assets/phasetida_wasm_core_bg-Dlb4M4tW.wasm",V=async(t={},e)=>{let n;if(e.startsWith("data:")){const o=e.replace(/^data:.*?base64,/,"");let i;if(typeof Buffer=="function"&&typeof Buffer.from=="function")i=Buffer.from(o,"base64");else if(typeof atob=="function"){const s=atob(o);i=new Uint8Array(s.length);for(let a=0;a<s.length;a++)i[a]=s.charCodeAt(a)}else throw new Error("Cannot decode base64-encoded data URL");n=await WebAssembly.instantiate(i,t)}else{const o=await fetch(e),i=o.headers.get("Content-Type")||"";if("instantiateStreaming"in WebAssembly&&i.startsWith("application/wasm"))n=await WebAssembly.instantiateStreaming(o,t);else{const s=await o.arrayBuffer();n=await WebAssembly.instantiate(s,t)}}return n.instance.exports};let _;function O(t){_=t}let g=null;function U(){return(g===null||g.buffer.detached===!0||g.buffer.detached===void 0&&g.buffer!==_.memory.buffer)&&(g=new DataView(_.memory.buffer)),g}function A(t,e){return t=t>>>0,M(t,e)}let S=null;function T(){return(S===null||S.byteLength===0)&&(S=new Uint8Array(_.memory.buffer)),S}function D(t,e,n){if(n===void 0){const r=y.encode(t),c=e(r.length,1)>>>0;return T().subarray(c,c+r.length).set(r),v=r.length,c}let o=t.length,i=e(o,1)>>>0;const s=T();let a=0;for(;a<o;a++){const r=t.charCodeAt(a);if(r>127)break;s[i+a]=r}if(a!==o){a!==0&&(t=t.slice(a)),i=n(i,o,o=a+t.length*3,1)>>>0;const r=T().subarray(i+a,i+o),c=y.encodeInto(t,r);a+=c.written,i=n(i,o,a,1)>>>0}return v=a,i}function L(t){const e=_.__wbindgen_externrefs.get(t);return _.__externref_table_dealloc(t),e}let E=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});E.decode();const $=2146435072;let F=0;function M(t,e){return F+=e,F>=$&&(E=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),E.decode(),F=e),E.decode(T().subarray(t,t+e))}const y=new TextEncoder;"encodeInto"in y||(y.encodeInto=function(t,e){const n=y.encode(t);return e.set(n),{read:t.length,written:n.length}});let v=0;function R(t){const e=D(t,_.__wbindgen_malloc,_.__wbindgen_realloc),n=v,o=_.load_level(e,n);if(o[2])throw L(o[1]);return L(o[0])}function W(t,e,n){const o=_.pre_draw(t,e,n);if(o[1])throw L(o[0])}function H(t){const e=_.reset_note_state(t);if(e[1])throw L(e[0])}function P(t,e){const n=String(e),o=D(n,_.__wbindgen_malloc,_.__wbindgen_realloc),i=v;U().setInt32(t+4,i,!0),U().setInt32(t+0,o,!0)}function z(t,e){throw new Error(A(t,e))}function N(t,e){return t[e>>>0]}function X(){return new Object}function Y(t,e,n){t[e]=n}function q(t,e,n){t[e>>>0]=n}function K(){return window.inputBuffer}function G(){return window.outputBuffer}function J(t,e){return A(t,e)}function Q(t){return t}function Z(){const t=_.__wbindgen_externrefs,e=t.grow(4);t.set(0,void 0),t.set(e+0,void 0),t.set(e+1,null),t.set(e+2,!0),t.set(e+3,!1)}URL=globalThis.URL;const h=await V({"./phasetida_wasm_core_bg.js":{__wbg_static_accessor_INPUT_BUFFER_ab100a430c012a25:K,__wbg_static_accessor_OUTPUT_BUFFER_6c38c10c80662821:G,__wbg_set_3f1d0b984ed272ed:Y,__wbg_String_8f0eb39a4a4c2f66:P,__wbg_new_1ba21ce319a06297:X,__wbg_get_index_4e7b3f629a0ab9cd:N,__wbg_set_index_04c4b93e64d08a52:q,__wbg___wbindgen_throw_dd24417ed36fc46e:z,__wbindgen_init_externref_table:Z,__wbindgen_cast_2241b6af4c4b2941:J,__wbindgen_cast_d6cd19b81560fd6e:Q}},j),ee=h.memory,te=h.load_level,ne=h.pre_draw,ie=h.reset_note_state,oe=h.__wbindgen_malloc,ae=h.__wbindgen_realloc,se=h.__wbindgen_externrefs,re=h.__externref_table_dealloc,C=h.__wbindgen_start,ce=Object.freeze(Object.defineProperty({__proto__:null,__externref_table_dealloc:re,__wbindgen_externrefs:se,__wbindgen_malloc:oe,__wbindgen_realloc:ae,__wbindgen_start:C,load_level:te,memory:ee,pre_draw:ne,reset_note_state:ie},Symbol.toStringTag,{value:"Module"}));O(ce);C();let le=class{dataView;cursor=0;littleEndian;constructor(e,n,o){this.dataView=new DataView(e,0,n),this.littleEndian=o}setFloat32(e){this.dataView.setFloat32(this.cursor,e,this.littleEndian),this.cursor+=4}setUint8(e){this.dataView.setUint8(this.cursor,e),this.cursor+=1}isFinished(){return this.dataView.byteLength<=this.cursor}},m=new Map;function de(){const t=document.getElementById("canvas");t.addEventListener("touchstart",e=>{for(const n of e.changedTouches)m.set(n.identifier,{touchId:n.identifier,x:n.clientX,y:n.clientY,active:!0});e.preventDefault()}),t.addEventListener("touchmove",e=>{for(const n of e.changedTouches)m.has(n.identifier)&&m.set(n.identifier,{touchId:n.identifier,x:n.clientX,y:n.clientY,active:!0});e.preventDefault()}),t.addEventListener("touchend",e=>{for(const n of e.changedTouches)m.set(n.identifier,{touchId:n.identifier,x:n.clientX,y:n.clientY,active:!1});e.preventDefault()}),t.addEventListener("touchcancel",e=>{for(const n of e.changedTouches)m.delete(n.identifier);e.preventDefault()})}function ue(t,e){const n=new le(t.buffer,t.length,!0);window.simEnableTouch&&m.forEach(o=>{if(o==null||!o.active)return;const[i,s]=e.unProject(o.x,o.y);n.setUint8(1),n.setUint8(o.touchId),n.setFloat32(i),n.setFloat32(s)}),n.setUint8(0)}class _e{worldWidth;worldHeight;scale=0;constructor(e,n){this.worldWidth=e,this.worldHeight=n}update(e,n){this.scale=Math.min(e/this.worldWidth,n/this.worldHeight)}project(e,n){return[e*this.scale,n*this.scale]}unProject(e,n){return[e/this.scale,n/this.scale]}projectSize(e){return e*this.scale}}class we{dataView;cursor=0;littleEndian;constructor(e,n,o){this.dataView=new DataView(e,0,n),this.littleEndian=o}getFloat32(){let e=this.dataView.getFloat32(this.cursor,this.littleEndian);return this.cursor+=4,e}getUint8(){let e=this.dataView.getUint8(this.cursor);return this.cursor+=1,e}getUint32(){let e=this.dataView.getUint32(this.cursor,this.littleEndian);return this.cursor+=4,e}isFinished(){return this.dataView.byteLength<=this.cursor}}function fe(t,e,n){const o=document.getElementById("canvas"),i=o.getContext("2d"),s=new _e(1920,1080);window._simStartTime=Date.now(),window._simLastChangeSpeedTime=0,window._simLastTimeInSecond=window._simStartTime/1e3;const a=document.getElementById("sim-playback-time"),r=document.getElementById("sim-playback-time-display");function c(){const l=Date.now(),d=window._simLastChangeSpeedTime/1e3+(l-window._simStartTime)/1e3*window._simSpeed;s.update(window.innerWidth,window.innerHeight);const[u,f]=[s.projectSize(1920),s.projectSize(1080)];o.width=u,o.height=f,i.clearRect(0,0,o.width,o.height),i.fillRect(0,0,u,f),i.lineWidth=s.projectSize(10),W(d,d-window._simLastTimeInSecond,window.simAuto),he(i,n,s,e),ue(t,s),window._simLastTimeInSecond=d,a.value=`${d*1e3}`,r.innerHTML=`${parseFloat(a.value)/1e3}`,window._simPlaying&&requestAnimationFrame(c)}requestAnimationFrame(c)}function B(t,e,n,o,i,s,a,r,c){const l=t.get(n);if(l===void 0){console.warn(`Image "${n}" not loaded`);return}let d,u,f;"image"in l?(d=l.image,u=l.width,f=l.height):(d=l,u=l.width,f=l.height);const b=a*Math.PI/180,w=u*s,p=c===null?f*s:c,k={x:w/2,y:p/2};e.save(),e.globalAlpha=1,e.translate(o,i),a!==0&&e.rotate(b),e.drawImage(d,-k.x,-k.y,w,p),e.restore()}function he(t,e,n,o){const i=new we(o.buffer,o.length,!0);for(;!i.isFinished();){const s=i.getUint8();if(s==0)break;switch(s){case 1:{const a=i.getFloat32(),r=i.getFloat32(),c=i.getFloat32(),l=i.getFloat32(),d=i.getFloat32();t.strokeStyle=`rgba(255, 254, 183, ${d})`,t.beginPath();const[u,f]=n.project(a,r),[b,w]=n.project(c,l);t.moveTo(u,f),t.lineTo(b,w),t.stroke();break}case 2:{const a=i.getUint8(),r=i.getFloat32(),c=i.getFloat32(),l=i.getFloat32(),d=i.getFloat32(),u=i.getUint8(),[f,b]=n.project(r,c);let w="tap",p=null;switch(a){case 1:w=u!=0&&window.simSimultaneousHighlight?"tap_hl":"tap";break;case 2:w=u!=0&&window.simSimultaneousHighlight?"drag_hl":"drag";break;case 4:w=u!=0&&window.simSimultaneousHighlight?"flick_hl":"flick";break;case 5:w=u!=0&&window.simSimultaneousHighlight?"hold_head_hl":"hold_head";break;case 6:w=u!=0&&window.simSimultaneousHighlight?"hold_body_hl":"hold_body",p=n.projectSize(d);break;case 7:w="hold_end";break}B(e,t,w,f,b,n.projectSize(.25),l,null,p);break}case 3:{const a=i.getFloat32(),r=i.getFloat32(),c=i.getUint8(),l=i.getUint8(),[d,u]=n.project(a,r);l==0?B(e,t,"effect_perfect_"+c,d,u,n.projectSize(1.5),0,null,null):l==1&&B(e,t,"effect_good_"+c,d,u,n.projectSize(1.5),0,null,null);break}case 4:{i.getFloat32(),i.getFloat32();break}case 5:{const a=document.getElementById("hint"),r=i.getUint32(),c=i.getUint32(),l=i.getFloat32(),d=i.getFloat32();a.innerHTML=`combo: ${r}<br>max combo: ${c}<br>score: ${l}<br>accurate: ${d}`}}}}async function ge(t){const e=await fetch(t),n=await e.arrayBuffer(),o=new Uint8Array(n),i=e.headers.get("content-type")||"image/jpeg",s=new Blob([o],{type:i}),a=URL.createObjectURL(s),r=new Image;return await new Promise((c,l)=>{r.onload=()=>{URL.revokeObjectURL(a),c(r)},r.onerror=l,r.src=a}),{image:r,width:r.naturalWidth,height:r.naturalHeight}}function x(t,e){const n=document.createElement("canvas");n.width=t.width,n.height=t.height;const o=n.getContext("2d");if(o==null)throw Error("failed to create context");const{image:i,width:s,height:a}=t;return o.drawImage(i,0,0),o.globalCompositeOperation="source-in",o.fillStyle=e,o.fillRect(0,0,s,a),o.globalCompositeOperation="source-over",n}function me(){const t=document.getElementById("sim-auto-play"),e=document.getElementById("sim-enable-input"),n=document.getElementById("sim-playback-speed"),o=document.getElementById("sim-playback-time-set"),i=document.getElementById("sim-playback-speed-apply"),s=document.getElementById("sim-playback-time-set-apply");t.onchange=c=>{window.simAuto=t.checked,e.disabled=t.checked,e.checked=!1},e.onchange=c=>{window.simEnableTouch=e.checked};const a=function(c){if(c=="Enter"){const l=parseFloat(n.value);if(Number.isNaN(l))return;window.simSetSpeed(l)}},r=function(c){if(c=="Enter"){const l=parseFloat(o.value);if(Number.isNaN(l))return;window.simSetTime(l)}};n.onkeydown=c=>{const l=c.key;a(l)},o.onkeydown=c=>{const l=c.key;r(l)},i.onclick=c=>{a("Enter")},s.onclick=c=>{r("Enter")}}function be(t){const e=document.getElementById("sim-playback-time");e.min="0",e.max=`${t*1e3}`}(async()=>{console.info("phasetida-node");const t=1024,e=65536;console.info(`initializing buffers, input:${t}, output:${e}`),window.simAuto=!0,window.simSimultaneousHighlight=!0,window.simEnableTouch=!1,window.inputBuffer=I(t),window.outputBuffer=I(e),window.inputBufferLength=t,window.outputBufferLength=e,window._simSpeed=1,window._simPlaying=!1,window._simPlayLock=!1,window.simSetSpeed=a=>{window._simLastChangeSpeedTime+=(Date.now()-window._simStartTime)*window._simSpeed,window._simStartTime=Date.now(),window._simSpeed=a},window.simSetTime=a=>{window._simLastChangeSpeedTime=0,window._simStartTime=Date.now()-a*1e3/window._simSpeed,window._simLastTimeInSecond=0,H(a)},window.simSetShowControls=a=>{document.getElementById("debug-container").hidden=!a},window.simLoadLevel=a=>{const r=document.getElementById("sim-use-default-level");r.hidden=!0,window._simPlaying=!1,console.info("initializing level");const c=R(a);console.info(`level load result: ${c}`),console.info(`song length: ${c.length_in_second}`),be(c.length_in_second),window._simLastTimeInSecond=0,window._simLastChangeSpeedTime=0,window._simPlaying=!0,fe(window.inputBuffer,window.outputBuffer,n)},me(),console.info("loading assets");const n=new Map,o=document.getElementById("hint");async function i(a,r){o.innerHTML=`loading ${r}->${a}`,n.set(a,await ge(r))}await i("tap","./note/tap.png"),await i("drag","./note/drag.png"),await i("flick","./note/flick.png"),await i("hold_head","./note/hold_head.png"),await i("hold_body","./note/hold_body.png"),await i("hold_end","./note/hold_end.png"),await i("tap_hl","./note/tap_hl.png"),await i("drag_hl","./note/drag_hl.png"),await i("flick_hl","./note/flick_hl.png"),await i("hold_head_hl","./note/hold_head_hl.png"),await i("hold_body_hl","./note/hold_body_hl.png"),await i("hold_body_hl","./note/hold_body_hl.png");for(let a=0;a<=29;a++){await i("click_"+a,"./click/click"+a+".png");let r=n.get("click_"+a);n.set("effect_perfect_"+a,x(r,"rgba(255, 254, 183, 255)")),n.set("effect_good_"+a,x(r,"rgba(168, 239, 246, 255)"))}console.info("initializing canvas"),de(),console.info("waiting for level... (use 'window.')"),o.innerHTML="waiting for level...";const s=document.getElementById("sim-use-default-level");s.hidden=!1,s.onclick=async a=>{o.innerHTML="loading default level...";const r=await(await fetch("./test.json")).text();window.simLoadLevel(r)}})();
