(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const c of i)if(c.type==="childList")for(const o of c.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const c={};return i.integrity&&(c.integrity=i.integrity),i.referrerPolicy&&(c.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?c.credentials="include":i.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(i){if(i.ep)return;i.ep=!0;const c=n(i);fetch(i.href,c)}})();function I(t){let e=new ArrayBuffer(t);return new Uint8Array(e)}const H="/phasetida-node-demo/assets/phasetida_wasm_core_bg-DcmFj-FN.wasm",R=async(t={},e)=>{let n;if(e.startsWith("data:")){const a=e.replace(/^data:.*?base64,/,"");let i;if(typeof Buffer=="function"&&typeof Buffer.from=="function")i=Buffer.from(a,"base64");else if(typeof atob=="function"){const c=atob(a);i=new Uint8Array(c.length);for(let o=0;o<c.length;o++)i[o]=c.charCodeAt(o)}else throw new Error("Cannot decode base64-encoded data URL");n=await WebAssembly.instantiate(i,t)}else{const a=await fetch(e),i=a.headers.get("Content-Type")||"";if("instantiateStreaming"in WebAssembly&&i.startsWith("application/wasm"))n=await WebAssembly.instantiateStreaming(a,t);else{const c=await a.arrayBuffer();n=await WebAssembly.instantiate(c,t)}}return n.instance.exports};let f;function W(t){f=t}let h=null;function U(){return(h===null||h.buffer.detached===!0||h.buffer.detached===void 0&&h.buffer!==f.memory.buffer)&&(h=new DataView(f.memory.buffer)),h}function A(t,e){return t=t>>>0,P(t,e)}let L=null;function T(){return(L===null||L.byteLength===0)&&(L=new Uint8Array(f.memory.buffer)),L}function j(t,e,n){if(n===void 0){const s=S.encode(t),l=e(s.length,1)>>>0;return T().subarray(l,l+s.length).set(s),k=s.length,l}let a=t.length,i=e(a,1)>>>0;const c=T();let o=0;for(;o<a;o++){const s=t.charCodeAt(o);if(s>127)break;c[i+o]=s}if(o!==a){o!==0&&(t=t.slice(o)),i=n(i,a,a=o+t.length*3,1)>>>0;const s=T().subarray(i+o,i+a),l=S.encodeInto(t,s);o+=l.written,i=n(i,a,o,1)>>>0}return k=o,i}function x(t){const e=f.__wbindgen_externrefs.get(t);return f.__externref_table_dealloc(t),e}let v=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});v.decode();const z=2146435072;let F=0;function P(t,e){return F+=e,F>=z&&(v=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),v.decode(),F=e),v.decode(T().subarray(t,t+e))}const S=new TextEncoder;"encodeInto"in S||(S.encodeInto=function(t,e){const n=S.encode(t);return e.set(n),{read:t.length,written:n.length}});let k=0;function M(t,e,n,a){f.load_image_offset(t,e,n,a)}function N(t){const e=j(t,f.__wbindgen_malloc,f.__wbindgen_realloc),n=k,a=f.load_level(e,n);if(a[2])throw x(a[1]);return x(a[0])}function X(t,e,n){f.pre_draw(t,e,n)}function Y(t){f.reset_note_state(t)}function q(t,e){const n=String(e),a=j(n,f.__wbindgen_malloc,f.__wbindgen_realloc),i=k;U().setInt32(t+4,i,!0),U().setInt32(t+0,a,!0)}function K(t,e){throw new Error(A(t,e))}function G(t,e){return t[e>>>0]}function J(){return new Object}function Q(t,e,n){t[e]=n}function Z(t,e,n){t[e>>>0]=n}function ee(){return window.inputBuffer}function te(){return window.outputBuffer}function ne(t,e){return A(t,e)}function ie(t){return t}function oe(){const t=f.__wbindgen_externrefs,e=t.grow(4);t.set(0,void 0),t.set(e+0,void 0),t.set(e+1,null),t.set(e+2,!0),t.set(e+3,!1)}URL=globalThis.URL;const g=await R({"./phasetida_wasm_core_bg.js":{__wbg_static_accessor_INPUT_BUFFER_a3d74950975ca7e3:ee,__wbg_static_accessor_OUTPUT_BUFFER_6bb37432c4e51ac8:te,__wbg_set_3f1d0b984ed272ed:Q,__wbg_String_8f0eb39a4a4c2f66:q,__wbg_new_1ba21ce319a06297:J,__wbg_get_index_4e7b3f629a0ab9cd:G,__wbg_set_index_04c4b93e64d08a52:Z,__wbg___wbindgen_throw_dd24417ed36fc46e:K,__wbindgen_init_externref_table:oe,__wbindgen_cast_2241b6af4c4b2941:ne,__wbindgen_cast_d6cd19b81560fd6e:ie}},H),ae=g.memory,se=g.load_image_offset,ce=g.load_level,re=g.pre_draw,le=g.reset_note_state,de=g.__wbindgen_malloc,we=g.__wbindgen_realloc,_e=g.__wbindgen_externrefs,fe=g.__externref_table_dealloc,C=g.__wbindgen_start,ue=Object.freeze(Object.defineProperty({__proto__:null,__externref_table_dealloc:fe,__wbindgen_externrefs:_e,__wbindgen_malloc:de,__wbindgen_realloc:we,__wbindgen_start:C,load_image_offset:se,load_level:ce,memory:ae,pre_draw:re,reset_note_state:le},Symbol.toStringTag,{value:"Module"}));W(ue);C();let ge=class{dataView;cursor=0;littleEndian;constructor(e,n,a){this.dataView=new DataView(e,0,n),this.littleEndian=a}setFloat32(e){this.dataView.setFloat32(this.cursor,e,this.littleEndian),this.cursor+=4}setUint8(e){this.dataView.setUint8(this.cursor,e),this.cursor+=1}isFinished(){return this.dataView.byteLength<=this.cursor}},m=new Map;function he(){const t=document.getElementById("canvas");t.addEventListener("touchstart",e=>{for(const n of e.changedTouches)m.set(n.identifier,{touchId:n.identifier,x:n.clientX,y:n.clientY,active:!0});e.preventDefault()}),t.addEventListener("touchmove",e=>{for(const n of e.changedTouches)m.has(n.identifier)&&m.set(n.identifier,{touchId:n.identifier,x:n.clientX,y:n.clientY,active:!0});e.preventDefault()}),t.addEventListener("touchend",e=>{for(const n of e.changedTouches)m.set(n.identifier,{touchId:n.identifier,x:n.clientX,y:n.clientY,active:!1});e.preventDefault()}),t.addEventListener("touchcancel",e=>{for(const n of e.changedTouches)m.delete(n.identifier);e.preventDefault()})}function me(t,e){const n=new ge(t.buffer,t.length,!0);window.simEnableTouch&&m.forEach(a=>{if(a==null||!a.active)return;const[i,c]=e.unProject(a.x,a.y);n.setUint8(1),n.setUint8(a.touchId),n.setFloat32(i),n.setFloat32(c)}),n.setUint8(0)}class be{worldWidth;worldHeight;scale=0;constructor(e,n){this.worldWidth=e,this.worldHeight=n}update(e,n){this.scale=Math.min(e/this.worldWidth,n/this.worldHeight)}project(e,n){return[e*this.scale,n*this.scale]}unProject(e,n){return[e/this.scale,n/this.scale]}projectSize(e){return e*this.scale}unProjectSize(e){return e/this.scale}}class pe{dataView;cursor=0;littleEndian;constructor(e,n,a){this.dataView=new DataView(e,0,n),this.littleEndian=a}getFloat32(){let e=this.dataView.getFloat32(this.cursor,this.littleEndian);return this.cursor+=4,e}getUint8(){let e=this.dataView.getUint8(this.cursor);return this.cursor+=1,e}getUint32(){let e=this.dataView.getUint32(this.cursor,this.littleEndian);return this.cursor+=4,e}isFinished(){return this.dataView.byteLength<=this.cursor}}let D=0,$=0,V=0,O=0;function ye(t,e,n){const a=document.getElementById("canvas"),i=a.getContext("2d"),c=new be(1920,1080);window._simStartTime=Date.now(),window._simLastChangeSpeedTime=0,window._simLastTimeInSecond=window._simStartTime/1e3;const o=document.getElementById("sim-playback-time"),s=document.getElementById("sim-playback-time-display");M(n.get("hold_head").height*.25*window.simElementScale,n.get("hold_head_hl").height*.25*window.simElementScale,n.get("hold_end").height*.25*window.simElementScale,n.get("hold_end").height*.25*window.simElementScale);function l(){const d=Date.now(),w=window._simLastChangeSpeedTime/1e3+(d-window._simStartTime)/1e3*window._simSpeed;c.update(window.innerWidth,window.innerHeight);const[r,_]=[c.projectSize(1920),c.projectSize(1080)];a.width=r,a.height=_,i.clearRect(0,0,a.width,a.height),i.fillRect(0,0,r,_),i.lineWidth=c.projectSize(10),X(w,w-window._simLastTimeInSecond,window.simAuto),Se(i,n,c,e),me(t,c),window._simLastTimeInSecond=w,o.value=`${w*1e3}`,s.innerHTML=`${parseFloat(o.value)/1e3}`,window.simLog&&d-window._simLastLogTime>=window.simLogLatency&&(window.flutter_inappwebview.callHandler("flutterTick",`&${w},${window._simSongLength},${D},${$},${V},${O}`),window._simLastLogTime=d),window._simPlaying&&requestAnimationFrame(l)}requestAnimationFrame(l)}function y(t,e,n,a,i,c,o,s,l){const d=t.get(n);if(d===void 0){console.warn(`Image "${n}" not loaded`);return}let w,r,_;"image"in d?(w=d.image,r=d.width,_=d.height):(w=d,r=d.width,_=d.height);const b=o*Math.PI/180,u=r*c,p=l===null?_*c:l,B={x:u/2,y:p/2};e.save(),e.globalAlpha=1,e.translate(a,i),o!==0&&e.rotate(b),e.drawImage(w,-B.x,-B.y,u,p),e.restore()}function Se(t,e,n,a){const i=new pe(a.buffer,a.length,!0);for(;!i.isFinished();){const c=i.getUint8();if(c==0)break;switch(c){case 1:{const o=i.getFloat32(),s=i.getFloat32(),l=i.getFloat32(),d=i.getFloat32(),w=i.getFloat32();t.strokeStyle=`rgba(255, 254, 183, ${w})`,t.beginPath();const[r,_]=n.project(o,s),[b,u]=n.project(l,d);t.moveTo(r,_),t.lineTo(b,u),t.stroke();break}case 2:{const o=i.getUint8(),s=i.getFloat32(),l=i.getFloat32(),d=i.getFloat32(),w=i.getFloat32(),r=i.getUint8(),[_,b]=n.project(s,l);let u="tap",p=null;switch(o){case 1:u=r!=0&&window.simSimultaneousHighlight?"tap_hl":"tap";break;case 2:u=r!=0&&window.simSimultaneousHighlight?"drag_hl":"drag";break;case 4:u=r!=0&&window.simSimultaneousHighlight?"flick_hl":"flick";break;case 5:u=r!=0&&window.simSimultaneousHighlight?"hold_head_hl":"hold_head";break;case 6:u=r!=0&&window.simSimultaneousHighlight?"hold_body_hl":"hold_body",p=n.projectSize(w);break;case 7:u="hold_end";break}y(e,t,u,_,b,n.projectSize(.25*window.simElementScale),d,null,p);break}case 3:{const o=i.getFloat32(),s=i.getFloat32(),l=i.getUint8(),d=i.getUint8(),[w,r]=n.project(o,s);if(window.simEffectLevel<=0)break;d==0?y(e,t,"effect_perfect_"+l,w,r,n.projectSize(1.5*window.simElementScale),0,null,null):d==1&&y(e,t,"effect_good_"+l,w,r,n.projectSize(1.5*window.simElementScale),0,null,null);break}case 4:{i.getFloat32(),i.getFloat32();break}case 5:{const o=document.getElementById("hint"),s=i.getUint32(),l=i.getUint32(),d=i.getFloat32(),w=i.getFloat32();D=s,$=l,V=d,O=w,o.innerHTML=`combo: ${s}<br>max combo: ${l}<br>score: ${d}<br>accurate: ${w}`;break}case 6:{const o=i.getFloat32(),s=i.getFloat32(),l=i.getUint8(),d=i.getUint8(),[w,r]=n.project(o,s);if(window.simEffectLevel<=1)break;d==0?y(e,t,"splash_perfect_"+l,w,r,n.projectSize(.35*window.simElementScale),0,null,null):d==1&&y(e,t,"splash_good_"+l,w,r,n.projectSize(.35*window.simElementScale),0,null,null)}}}}async function Le(t){const e=await fetch(t),n=await e.arrayBuffer(),a=new Uint8Array(n),i=e.headers.get("content-type")||"image/jpeg",c=new Blob([a],{type:i}),o=URL.createObjectURL(c),s=new Image;return await new Promise((l,d)=>{s.onload=()=>{URL.revokeObjectURL(o),l(s)},s.onerror=d,s.src=o}),{image:s,width:s.naturalWidth,height:s.naturalHeight}}function E(t,e){const n=document.createElement("canvas");n.width=t.width,n.height=t.height;const a=n.getContext("2d");if(a==null)throw Error("failed to create context");const{image:i,width:c,height:o}=t;return a.drawImage(i,0,0),a.globalCompositeOperation="source-in",a.fillStyle=e,a.fillRect(0,0,c,o),a.globalCompositeOperation="source-over",n}function Ee(){const t=document.getElementById("sim-auto-play"),e=document.getElementById("sim-enable-input"),n=document.getElementById("sim-playback-speed"),a=document.getElementById("sim-playback-time-set"),i=document.getElementById("sim-playback-speed-apply"),c=document.getElementById("sim-playback-time-set-apply"),o=document.getElementById("sim-effect-0"),s=document.getElementById("sim-effect-1"),l=document.getElementById("sim-effect-2");t.onchange=r=>{window.simAuto=t.checked,e.disabled=t.checked,e.checked=!1},e.onchange=r=>{window.simEnableTouch=e.checked};const d=function(r){if(r=="Enter"){const _=parseFloat(n.value);if(Number.isNaN(_))return;window.simSetSpeed(_)}},w=function(r){if(r=="Enter"){const _=parseFloat(a.value);if(Number.isNaN(_))return;window.simSetTime(_)}};o.onclick=r=>{window.simEffectLevel=0},s.onclick=r=>{window.simEffectLevel=1},l.onclick=r=>{window.simEffectLevel=2},n.onkeydown=r=>{const _=r.key;d(_)},a.onkeydown=r=>{const _=r.key;w(_)},i.onclick=r=>{d("Enter")},c.onclick=r=>{w("Enter")}}function Te(t){const e=document.getElementById("sim-playback-time");e.min="0",e.max=`${t*1e3}`}(async()=>{console.info("phasetida-node");const t=1024,e=65536;console.info(`initializing buffers, input:${t}, output:${e}`),window.simAuto=!0,window.simSimultaneousHighlight=!0,window.simEnableTouch=!1,window.simElementScale=1,window.simEffectLevel=2,window.inputBuffer=I(t),window.outputBuffer=I(e),window.inputBufferLength=t,window.outputBufferLength=e,window._simSpeed=1,window._simPlaying=!1,window._simPlayLock=!1,window.simLog=!1,window.simLogLatency=1e3/120,window._simLastLogTime=Date.now(),window.simSetSpeed=o=>{window._simLastChangeSpeedTime+=(Date.now()-window._simStartTime)*window._simSpeed,window._simStartTime=Date.now(),window._simSpeed=o},window.simSetTime=o=>{window._simLastChangeSpeedTime=0,window._simStartTime=Date.now()-o*1e3/window._simSpeed,window._simLastTimeInSecond=0,Y(o)},window.simSetShowControls=o=>{document.getElementById("debug-container").hidden=!o},window.simLoadLevel=o=>{const s=document.getElementById("sim-use-default-level");s.hidden=!0,window._simPlaying=!1,console.info("initializing level");const l=N(o);console.info(`level load result: ${l}`),console.info(`song length: ${l.length_in_second}`),Te(l.length_in_second),window._simSongLength=l.length_in_second,window._simLastTimeInSecond=0,window._simLastChangeSpeedTime=0,window._simPlaying=!0,ye(window.inputBuffer,window.outputBuffer,n)},Ee(),console.info("loading assets");const n=new Map,a=document.getElementById("hint");async function i(o,s){a.innerHTML=`loading ${s}->${o}`,n.set(o,await Le(s))}await i("tap","./note/tap.png"),await i("drag","./note/drag.png"),await i("flick","./note/flick.png"),await i("hold_head","./note/hold_head.png"),await i("hold_body","./note/hold_body.png"),await i("hold_end","./note/hold_end.png"),await i("tap_hl","./note/tap_hl.png"),await i("drag_hl","./note/drag_hl.png"),await i("flick_hl","./note/flick_hl.png"),await i("hold_head_hl","./note/hold_head_hl.png"),await i("hold_body_hl","./note/hold_body_hl.png"),await i("hold_body_hl","./note/hold_body_hl.png");for(let o=0;o<=29;o++){await i("click_"+o,"./click/click"+o+".png");let s=n.get("click_"+o);n.set("effect_perfect_"+o,E(s,"rgba(255, 254, 183, 255)")),n.set("effect_good_"+o,E(s,"rgba(168, 239, 246, 255)"))}for(let o=0;o<=29;o++){await i("splash_"+o,"./splash/splash"+o+".png");let s=n.get("splash_"+o);n.set("splash_perfect_"+o,E(s,"rgba(255, 254, 183, 255)")),n.set("splash_good_"+o,E(s,"rgba(168, 239, 246, 255)"))}console.info("initializing canvas"),he(),console.info("waiting for level... (use 'window.')"),a.innerHTML="waiting for level...";const c=document.getElementById("sim-use-default-level");c.hidden=!1,c.onclick=async o=>{a.innerHTML="loading default level...";const s=await(await fetch("./test.json")).text();window.simLoadLevel(s)}})();
