(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();function A(t){let e=new ArrayBuffer(t);return new Uint8Array(e)}const M="/phasetida-node-demo/assets/phasetida_wasm_core_bg-DzCU2z0O.wasm",P=async(t={},e)=>{let n;if(e.startsWith("data:")){const i=e.replace(/^data:.*?base64,/,"");let s;if(typeof Buffer=="function"&&typeof Buffer.from=="function")s=Buffer.from(i,"base64");else if(typeof atob=="function"){const a=atob(i);s=new Uint8Array(a.length);for(let o=0;o<a.length;o++)s[o]=a.charCodeAt(o)}else throw new Error("Cannot decode base64-encoded data URL");n=await WebAssembly.instantiate(s,t)}else{const i=await fetch(e),s=i.headers.get("Content-Type")||"";if("instantiateStreaming"in WebAssembly&&s.startsWith("application/wasm"))n=await WebAssembly.instantiateStreaming(i,t);else{const a=await i.arrayBuffer();n=await WebAssembly.instantiate(a,t)}}return n.instance.exports};let w;function N(t){w=t}let m=null;function C(){return(m===null||m.buffer.detached===!0||m.buffer.detached===void 0&&m.buffer!==w.memory.buffer)&&(m=new DataView(w.memory.buffer)),m}function j(t,e){return t=t>>>0,X(t,e)}let S=null;function E(){return(S===null||S.byteLength===0)&&(S=new Uint8Array(w.memory.buffer)),S}function $(t,e,n){if(n===void 0){const c=y.encode(t),r=e(c.length,1)>>>0;return E().subarray(r,r+c.length).set(c),k=c.length,r}let i=t.length,s=e(i,1)>>>0;const a=E();let o=0;for(;o<i;o++){const c=t.charCodeAt(o);if(c>127)break;a[s+o]=c}if(o!==i){o!==0&&(t=t.slice(o)),s=n(s,i,i=o+t.length*3,1)>>>0;const c=E().subarray(s+o,s+i),r=y.encodeInto(t,c);o+=r.written,s=n(s,i,o,1)>>>0}return k=o,s}function D(t){const e=w.__wbindgen_externrefs.get(t);return w.__externref_table_dealloc(t),e}let T=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});T.decode();const q=2146435072;let v=0;function X(t,e){return v+=e,v>=q&&(T=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),T.decode(),v=e),T.decode(E().subarray(t,t+e))}const y=new TextEncoder;"encodeInto"in y||(y.encodeInto=function(t,e){const n=y.encode(t);return e.set(n),{read:t.length,written:n.length}});let k=0;function Y(t,e,n,i){w.load_image_offset(t,e,n,i)}function K(t){const e=$(t,w.__wbindgen_malloc,w.__wbindgen_realloc),n=k,i=w.load_level(e,n);if(i[2])throw D(i[1]);return D(i[0])}function G(t,e,n){w.pre_draw(t,e,n)}function J(t){w.reset_note_state(t)}function Q(t,e){const n=String(e),i=$(n,w.__wbindgen_malloc,w.__wbindgen_realloc),s=k;C().setInt32(t+4,s,!0),C().setInt32(t+0,i,!0)}function Z(t,e){throw new Error(j(t,e))}function V(t,e){return t[e>>>0]}function ee(){return new Object}function te(t,e,n){t[e]=n}function ne(t,e,n){t[e>>>0]=n}function ie(){return window.inputBuffer}function oe(){return window.outputBuffer}function se(t,e){return j(t,e)}function ae(t){return t}function ce(){const t=w.__wbindgen_externrefs,e=t.grow(4);t.set(0,void 0),t.set(e+0,void 0),t.set(e+1,null),t.set(e+2,!0),t.set(e+3,!1)}URL=globalThis.URL;const h=await P({"./phasetida_wasm_core_bg.js":{__wbg_static_accessor_INPUT_BUFFER_e4d98a727d2c2064:ie,__wbg_static_accessor_OUTPUT_BUFFER_da0164f9b21b37b0:oe,__wbg_set_3f1d0b984ed272ed:te,__wbg_String_8f0eb39a4a4c2f66:Q,__wbg_new_1ba21ce319a06297:ee,__wbg_get_index_4e7b3f629a0ab9cd:V,__wbg_set_index_04c4b93e64d08a52:ne,__wbg___wbindgen_throw_dd24417ed36fc46e:Z,__wbindgen_init_externref_table:ce,__wbindgen_cast_2241b6af4c4b2941:se,__wbindgen_cast_d6cd19b81560fd6e:ae}},M),re=h.memory,le=h.load_image_offset,de=h.load_level,_e=h.pre_draw,fe=h.reset_note_state,we=h.__wbindgen_malloc,ge=h.__wbindgen_realloc,he=h.__wbindgen_externrefs,me=h.__externref_table_dealloc,O=h.__wbindgen_start,ue=Object.freeze(Object.defineProperty({__proto__:null,__externref_table_dealloc:me,__wbindgen_externrefs:he,__wbindgen_malloc:we,__wbindgen_realloc:ge,__wbindgen_start:O,load_image_offset:le,load_level:de,memory:re,pre_draw:_e,reset_note_state:fe},Symbol.toStringTag,{value:"Module"}));N(ue);O();let be=class{dataView;cursor=0;littleEndian;constructor(e,n,i){this.dataView=new DataView(e,0,n),this.littleEndian=i}setFloat32(e){this.dataView.setFloat32(this.cursor,e,this.littleEndian),this.cursor+=4}setUint8(e){this.dataView.setUint8(this.cursor,e),this.cursor+=1}isFinished(){return this.dataView.byteLength<=this.cursor}},u=new Map;function pe(){const t=document.getElementById("canvas");t.addEventListener("touchstart",e=>{for(const n of e.changedTouches)u.set(n.identifier,{touchId:n.identifier,x:n.clientX,y:n.clientY,active:!0});e.preventDefault()}),t.addEventListener("touchmove",e=>{for(const n of e.changedTouches)u.has(n.identifier)&&u.set(n.identifier,{touchId:n.identifier,x:n.clientX,y:n.clientY,active:!0});e.preventDefault()}),t.addEventListener("touchend",e=>{for(const n of e.changedTouches)u.set(n.identifier,{touchId:n.identifier,x:n.clientX,y:n.clientY,active:!1});e.preventDefault()}),t.addEventListener("touchcancel",e=>{for(const n of e.changedTouches)u.delete(n.identifier);e.preventDefault()})}function ye(t,e){const n=new be(t.buffer,t.length,!0);window.simEnableTouch&&u.forEach(i=>{if(i==null||!i.active)return;const[s,a]=e.unProject(i.x,i.y);n.setUint8(1),n.setUint8(i.touchId),n.setFloat32(s),n.setFloat32(a)}),n.setUint8(0)}class Se{worldWidth;worldHeight;scale=0;constructor(e,n){this.worldWidth=e,this.worldHeight=n}update(e,n){this.scale=Math.min(e/this.worldWidth,n/this.worldHeight)}project(e,n){return[e*this.scale,n*this.scale]}unProject(e,n){return[e/this.scale,n/this.scale]}projectSize(e){return e*this.scale}unProjectSize(e){return e/this.scale}}class Le{dataView;cursor=0;littleEndian;constructor(e,n,i){this.dataView=new DataView(e,0,n),this.littleEndian=i}getFloat32(){let e=this.dataView.getFloat32(this.cursor,this.littleEndian);return this.cursor+=4,e}getUint8(){let e=this.dataView.getUint8(this.cursor);return this.cursor+=1,e}getUint32(){let e=this.dataView.getUint32(this.cursor,this.littleEndian);return this.cursor+=4,e}isFinished(){return this.dataView.byteLength<=this.cursor}}let H=0,R=0,z=0,W=0,F=0,B=0,I=0;function Ee(t,e,n){const i=document.getElementById("canvas"),s=i.getContext("2d",{desynchronized:!1,willReadFrequently:!1}),a=new Se(1920,1080);window._simStartTime=Date.now(),window._simLastChangeSpeedTime=0,window._simLastTimeInSecond=window._simStartTime/1e3;const o=document.getElementById("sim-playback-time"),c=document.getElementById("sim-playback-time-display");Y(n.get("hold_head").height*.25*window.simElementScale,n.get("hold_head_hl").height*.25*window.simElementScale,n.get("hold_end").height*.25*window.simElementScale,n.get("hold_end").height*.25*window.simElementScale);const r=new Le(e.buffer,e.length,!0);function l(){r.cursor=0,F=0,B=0,I=0;const _=Date.now(),d=window._simLastChangeSpeedTime/1e3+(_-window._simStartTime)/1e3*window._simSpeed;a.update(window.innerWidth,window.innerHeight);const[f,g]=[a.projectSize(1920),a.projectSize(1080)];i.width=f,i.height=g,s.clearRect(0,0,i.width,i.height),s.fillRect(0,0,f,g),s.lineWidth=a.projectSize(10),G(d,d-window._simLastTimeInSecond,window.simAuto),Te(s,n,a,r),ye(t,a),window._simLastTimeInSecond=d,o.value=`${d*1e3}`,c.innerHTML=`${parseFloat(o.value)/1e3}`,window.simLog&&_-window._simLastLogTime>=window.simLogLatency&&(window.flutter_inappwebview.callHandler("flutterTick",d,window._simSongLength,H,R,z,W,F,B,I),window._simLastLogTime=_),window._simPlaying&&requestAnimationFrame(l)}requestAnimationFrame(l)}function p(t,e,n,i,s,a,o,c,r){const l=t.get(n);if(l===void 0){console.warn(`Image "${n}" not loaded`);return}let _,d,f;"image"in l?(_=l.image,d=l.width,f=l.height):(_=l,d=l.width,f=l.height);const g=o*Math.PI/180,b=d*a,U=r===null?f*a:r,x={x:b/2,y:U/2};e.save(),e.globalAlpha=1,e.translate(i,s),o!==0&&e.rotate(g),e.drawImage(_,-x.x,-x.y,b,U),e.restore()}function Te(t,e,n,i){for(;!i.isFinished();){const s=i.getUint8();if(s==0)break;switch(s){case 1:{const a=i.getFloat32(),o=i.getFloat32(),c=i.getFloat32(),r=i.getFloat32(),l=i.getFloat32();t.strokeStyle=`rgba(255, 254, 183, ${l})`,t.beginPath();const[_,d]=n.project(a,o),[f,g]=n.project(c,r);t.moveTo(_,d),t.lineTo(f,g),t.stroke();break}case 2:{const a=i.getUint8(),o=i.getFloat32(),c=i.getFloat32(),r=i.getFloat32(),l=i.getFloat32(),_=i.getUint8(),[d,f]=n.project(o,c);let g="tap",b=null;switch(a){case 1:g=_!=0&&window.simSimultaneousHighlight?"tap_hl":"tap";break;case 2:g=_!=0&&window.simSimultaneousHighlight?"drag_hl":"drag";break;case 4:g=_!=0&&window.simSimultaneousHighlight?"flick_hl":"flick";break;case 5:g=_!=0&&window.simSimultaneousHighlight?"hold_head_hl":"hold_head";break;case 6:g=_!=0&&window.simSimultaneousHighlight?"hold_body_hl":"hold_body",b=n.projectSize(l);break;case 7:g="hold_end";break}p(e,t,g,d,f,n.projectSize(.25*window.simElementScale),r,null,b);break}case 3:{const a=i.getFloat32(),o=i.getFloat32(),c=i.getUint8(),r=i.getUint8(),[l,_]=n.project(a,o);if(window.simEffectLevel<=0)break;r==0?p(e,t,"effect_perfect_"+c,l,_,n.projectSize(1.5*window.simElementScale),0,null,null):r==1&&p(e,t,"effect_good_"+c,l,_,n.projectSize(1.5*window.simElementScale),0,null,null);break}case 4:{i.getFloat32(),i.getFloat32();break}case 5:{const a=i.getUint32(),o=i.getUint32(),c=i.getFloat32(),r=i.getFloat32();H=a,R=o,z=c,W=r;const l=document.getElementById("hint");l.innerHTML=`combo: ${a}<br>max combo: ${o}<br>score: ${c}<br>accurate: ${r}`;break}case 6:{const a=i.getFloat32(),o=i.getFloat32(),c=i.getUint8(),r=i.getUint8(),[l,_]=n.project(a,o);if(window.simEffectLevel<=1)break;r==0?p(e,t,"splash_perfect_"+c,l,_,n.projectSize(.35*window.simElementScale),0,null,null):r==1&&p(e,t,"splash_good_"+c,l,_,n.projectSize(.35*window.simElementScale),0,null,null);break}case 7:{const a=i.getUint8(),o=i.getUint8(),c=i.getUint8();F=a,B=o,I=c;const r=document.getElementById("sounds");r.innerHTML=`${a} ${o} ${c}<br>`}}}}async function ke(t){const e=await fetch(t),n=await e.arrayBuffer(),i=new Uint8Array(n),s=e.headers.get("content-type")||"image/jpeg",a=new Blob([i],{type:s}),o=URL.createObjectURL(a),c=new Image;return await new Promise((r,l)=>{c.onload=()=>{URL.revokeObjectURL(o),r(c)},c.onerror=l,c.src=o}),{image:c,width:c.naturalWidth,height:c.naturalHeight}}function L(t,e){const n=document.createElement("canvas");n.width=t.width,n.height=t.height;const i=n.getContext("2d");if(i==null)throw Error("failed to create context");const{image:s,width:a,height:o}=t;return i.drawImage(s,0,0),i.globalCompositeOperation="source-in",i.fillStyle=e,i.fillRect(0,0,a,o),i.globalCompositeOperation="source-over",n}function ve(){const t=document.getElementById("sim-auto-play"),e=document.getElementById("sim-enable-input"),n=document.getElementById("sim-playback-speed"),i=document.getElementById("sim-playback-time-set"),s=document.getElementById("sim-playback-speed-apply"),a=document.getElementById("sim-playback-time-set-apply"),o=document.getElementById("sim-effect-0"),c=document.getElementById("sim-effect-1"),r=document.getElementById("sim-effect-2");t.onchange=d=>{window.simAuto=t.checked,e.disabled=t.checked,e.checked=!1},e.onchange=d=>{window.simEnableTouch=e.checked};const l=function(d){if(d=="Enter"){const f=parseFloat(n.value);if(Number.isNaN(f))return;window.simSetSpeed(f)}},_=function(d){if(d=="Enter"){const f=parseFloat(i.value);if(Number.isNaN(f))return;window.simSetTime(f)}};o.onclick=d=>{window.simEffectLevel=0},c.onclick=d=>{window.simEffectLevel=1},r.onclick=d=>{window.simEffectLevel=2},n.onkeydown=d=>{const f=d.key;l(f)},i.onkeydown=d=>{const f=d.key;_(f)},s.onclick=d=>{l("Enter")},a.onclick=d=>{_("Enter")}}function Fe(t){const e=document.getElementById("sim-playback-time");e.min="0",e.max=`${t*1e3}`}(async()=>{console.info("phasetida-node");const t=1024,e=65536;console.info(`initializing buffers, input:${t}, output:${e}`),window.simAuto=!0,window.simSimultaneousHighlight=!0,window.simEnableTouch=!1,window.simElementScale=1,window.simEffectLevel=2,window.inputBuffer=A(t),window.outputBuffer=A(e),window.inputBufferLength=t,window.outputBufferLength=e,window._simSpeed=1,window._simPlaying=!1,window._simPlayLock=!1,window.simLog=!1,window.simLogLatency=1e3/120,window._simLastLogTime=Date.now(),window.simSetSpeed=o=>{window._simLastChangeSpeedTime+=(Date.now()-window._simStartTime)*window._simSpeed,window._simStartTime=Date.now(),window._simSpeed=o},window.simSetTime=o=>{window._simLastChangeSpeedTime=0,window._simStartTime=Date.now()-o*1e3/window._simSpeed,window._simLastTimeInSecond=0,J(o)},window.simSetShowControls=o=>{document.getElementById("debug-container").hidden=!o},window.simLoadLevel=o=>{const c=document.getElementById("sim-use-default-level");c.hidden=!0,window._simPlaying=!1,console.info("initializing level");const r=K(o);console.info(`level load result: ${r}`),console.info(`song length: ${r.length_in_second}`),Fe(r.length_in_second),window._simSongLength=r.length_in_second,window._simLastTimeInSecond=0,window._simLastChangeSpeedTime=0,window._simPlaying=!0,Ee(window.inputBuffer,window.outputBuffer,n)},ve(),console.info("loading assets");const n=new Map,i=document.getElementById("hint");async function s(o,c){i.innerHTML=`loading ${c}->${o}`,n.set(o,await ke(c))}await s("tap","./note/tap.png"),await s("drag","./note/drag.png"),await s("flick","./note/flick.png"),await s("hold_head","./note/hold_head.png"),await s("hold_body","./note/hold_body.png"),await s("hold_end","./note/hold_end.png"),await s("tap_hl","./note/tap_hl.png"),await s("drag_hl","./note/drag_hl.png"),await s("flick_hl","./note/flick_hl.png"),await s("hold_head_hl","./note/hold_head_hl.png"),await s("hold_body_hl","./note/hold_body_hl.png"),await s("hold_body_hl","./note/hold_body_hl.png");for(let o=0;o<=29;o++){await s("click_"+o,"./click/click"+o+".png");let c=n.get("click_"+o);n.set("effect_perfect_"+o,L(c,"rgba(255, 254, 183, 255)")),n.set("effect_good_"+o,L(c,"rgba(168, 239, 246, 255)"))}for(let o=0;o<=29;o++){await s("splash_"+o,"./splash/splash"+o+".png");let c=n.get("splash_"+o);n.set("splash_perfect_"+o,L(c,"rgba(255, 254, 183, 255)")),n.set("splash_good_"+o,L(c,"rgba(168, 239, 246, 255)"))}console.info("initializing canvas"),pe(),console.info("waiting for level... (use 'window.')"),i.innerHTML="waiting for level...";const a=document.getElementById("sim-use-default-level");a.hidden=!1,a.onclick=async o=>{i.innerHTML="loading default level...";const c=await(await fetch("./test.json")).text();window.simLoadLevel(c)}})();
